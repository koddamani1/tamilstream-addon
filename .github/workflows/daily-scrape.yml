name: Daily TamilDhool Scrape

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Scrape Latest Episodes
        run: |
          echo "Fetching latest episodes from TamilDhool..."
          curl -sX GET "${{ secrets.VERCEL_URL }}/api/scrape/latest" | head -100
          
      - name: Update Content Catalog
        run: |
          echo "Updating full content catalog..."
          response=$(curl -sX POST "${{ secrets.VERCEL_URL }}/api/scrape/update")
          echo "$response"
          
          scraped=$(echo "$response" | jq -r '.scraped // 0')
          added=$(echo "$response" | jq -r '.added // 0')
          
          echo "Scraped: $scraped shows"
          echo "Added/Updated: $added shows"
          
      - name: Verify Catalog
        run: |
          echo "Verifying catalog update..."
          curl -s "${{ secrets.VERCEL_URL }}/catalog/series/tamilstream_series.json" | jq '.metas | length' | xargs -I {} echo "Total series in catalog: {}"
